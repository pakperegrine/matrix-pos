<div class="customer-management">
  <!-- Header -->
  <div class="page-header">
    <h2>Customer Management</h2>
    <button class="btn-primary" (click)="openCreateModal()">
      <span class="icon">‚ûï</span>
      Add Customer
    </button>
  </div>

  <!-- Filters -->
  <div class="filters-bar">
    <div class="search-box">
      <input 
        type="text" 
        [(ngModel)]="searchQuery"
        (ngModelChange)="onSearchChange()"
        placeholder="Search customers..."
        class="search-input"
      />
    </div>
    
    <select [(ngModel)]="filterType" (ngModelChange)="onFilterChange()" class="filter-select">
      <option value="all">All Types</option>
      <option value="regular">Regular</option>
      <option value="wholesale">Wholesale</option>
      <option value="vip">VIP</option>
    </select>

    <select [(ngModel)]="filterActive" (ngModelChange)="onFilterChange()" class="filter-select">
      <option value="all">All Status</option>
      <option value="active">Active</option>
      <option value="inactive">Inactive</option>
    </select>

    <div class="results-count">
      {{ filteredCustomers.length }} customer{{filteredCustomers.length !== 1 ? 's' : ''}}
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="spinner"></div>
    <p>Loading customers...</p>
  </div>

  <!-- Customer Table -->
  <div *ngIf="!loading" class="table-container">
    <table class="customers-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Contact</th>
          <th>Type</th>
          <th>Loyalty Tier</th>
          <th>Points</th>
          <th>Total Purchases</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let customer of paginatedCustomers">
          <td>
            <div class="customer-name">
              <div class="avatar">{{ customer.name.charAt(0).toUpperCase() }}</div>
              <span>{{ customer.name }}</span>
            </div>
          </td>
          <td>
            <div class="contact-info">
              <div *ngIf="customer.email">üìß {{ customer.email }}</div>
              <div *ngIf="customer.phone">üìû {{ customer.phone }}</div>
            </div>
          </td>
          <td><span class="badge badge-type-{{customer.customer_type}}">{{ customer.customer_type }}</span></td>
          <td>
            <span 
              class="badge badge-tier" 
              [style.background]="getLoyaltyTierInfo(customer.loyalty_tier || 'bronze').color"
            >
              {{ getLoyaltyTierInfo(customer.loyalty_tier || 'bronze').label }}
            </span>
          </td>
          <td>{{ customer.loyalty_points || 0 }}</td>
          <td>{{ formatCurrency(customer.total_purchases || 0) }}</td>
          <td>
            <span [class]="customer.is_active ? 'badge-success' : 'badge-inactive'">
              {{ customer.is_active ? 'Active' : 'Inactive' }}
            </span>
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon" (click)="viewCustomerStats(customer)" title="View Stats">üìä</button>
              <button class="btn-icon" (click)="openEditModal(customer)" title="Edit">‚úèÔ∏è</button>
              <button class="btn-icon btn-danger" (click)="deleteCustomer(customer)" title="Delete">üóëÔ∏è</button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Pagination -->
    <div class="pagination" *ngIf="totalPages > 1">
      <button (click)="previousPage()" [disabled]="currentPage === 1">Previous</button>
      <span>Page {{ currentPage }} of {{ totalPages }}</span>
      <button (click)="nextPage()" [disabled]="currentPage === totalPages">Next</button>
    </div>
  </div>

  <!-- Customer Form Modal -->
  <app-modal *ngIf="showModal" [isOpen]="showModal" (close)="closeModal()">>
    <h3 header>{{ isEditing ? 'Edit Customer' : 'Add New Customer' }}</h3>
    
    <div content class="customer-form">
      <div class="form-section">
        <h4>Basic Information</h4>
        <div class="form-row">
          <div class="form-group">
            <label>Customer Name *</label>
            <input type="text" [(ngModel)]="customerForm.name" [class.error]="formErrors['name']" />
            <span class="error-message" *ngIf="formErrors['name']">{{ formErrors['name'] }}</span>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Email</label>
            <input type="email" [(ngModel)]="customerForm.email" [class.error]="formErrors['email']" />
            <span class="error-message" *ngIf="formErrors['email']">{{ formErrors['email'] }}</span>
          </div>
          <div class="form-group">
            <label>Phone</label>
            <input type="tel" [(ngModel)]="customerForm.phone" [class.error]="formErrors['phone']" />
            <span class="error-message" *ngIf="formErrors['phone']">{{ formErrors['phone'] }}</span>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h4>Address</h4>
        <div class="form-group">
          <label>Street Address</label>
          <textarea [(ngModel)]="customerForm.address" rows="2"></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>City</label>
            <input type="text" [(ngModel)]="customerForm.city" />
          </div>
          <div class="form-group">
            <label>Postal Code</label>
            <input type="text" [(ngModel)]="customerForm.postal_code" />
          </div>
        </div>
      </div>

      <div class="form-section">
        <h4>Customer Settings</h4>
        <div class="form-row">
          <div class="form-group">
            <label>Customer Type</label>
            <select [(ngModel)]="customerForm.customer_type">
              <option *ngFor="let type of customerTypes" [value]="type.value">{{ type.label }}</option>
            </select>
          </div>
          <div class="form-group">
            <label>Discount %</label>
            <input type="number" [(ngModel)]="customerForm.discount_percentage" min="0" max="100" step="0.1" />
          </div>
        </div>
        <div class="form-group">
          <label>Credit Limit</label>
          <input type="number" [(ngModel)]="customerForm.credit_limit" min="0" step="0.01" />
        </div>
      </div>

      <div class="form-section">
        <h4>Additional Information</h4>
        <div class="form-group">
          <label>Notes</label>
          <textarea [(ngModel)]="customerForm.notes" rows="3"></textarea>
        </div>
        <div class="form-group checkbox-group">
          <label>
            <input type="checkbox" [(ngModel)]="customerForm.is_active" />
            Active Customer
          </label>
        </div>
      </div>
    </div>

    <div footer class="modal-actions">
      <button class="btn-secondary" (click)="closeModal()" [disabled]="savingCustomer">Cancel</button>
      <button class="btn-primary" (click)="saveCustomer()" [disabled]="savingCustomer">
        <span *ngIf="!savingCustomer">{{ isEditing ? 'Update' : 'Create' }} Customer</span>
        <span *ngIf="savingCustomer">Saving...</span>
      </button>
    </div>
  </app-modal>

  <!-- Customer Stats Modal -->
  <app-modal *ngIf="showStatsModal && selectedCustomer" [isOpen]="showStatsModal" (close)="closeStatsModal()">
    <h3 header>Customer Statistics - {{ selectedCustomer.name }}</h3>
    
    <div content class="stats-content" *ngIf="customerStats">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">üí∞</div>
          <div class="stat-value">{{ formatCurrency(customerStats.total_purchases) }}</div>
          <div class="stat-label">Total Purchases</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üõí</div>
          <div class="stat-value">{{ customerStats.purchase_count }}</div>
          <div class="stat-label">Number of Orders</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚≠ê</div>
          <div class="stat-value">{{ customerStats.loyalty_points }}</div>
          <div class="stat-label">Loyalty Points</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üìä</div>
          <div class="stat-value">{{ formatCurrency(customerStats.average_purchase) }}</div>
          <div class="stat-label">Average Purchase</div>
        </div>
      </div>

      <div class="stats-details">
        <p><strong>Loyalty Tier:</strong> <span class="badge badge-tier" [style.background]="getLoyaltyTierInfo(customerStats.loyalty_tier).color">{{ getLoyaltyTierInfo(customerStats.loyalty_tier).label }}</span></p>
        <p><strong>Customer Since:</strong> {{ formatDate(customerStats.customer_since) }}</p>
        <p><strong>Last Purchase:</strong> {{ formatDate(customerStats.last_purchase_date) }}</p>
        <p><strong>Current Balance:</strong> {{ formatCurrency(customerStats.current_balance) }}</p>
        <p><strong>Credit Limit:</strong> {{ formatCurrency(customerStats.credit_limit) }}</p>
      </div>
    </div>

    <div footer class="modal-actions">
      <button class="btn-primary" (click)="closeStatsModal()">Close</button>
    </div>
  </app-modal>
</div>
