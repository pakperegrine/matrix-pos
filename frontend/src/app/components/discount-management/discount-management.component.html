<div class="discount-management">
  <div class="header">
    <h2>Discount & Promotion Management</h2>
    <button class="btn btn-primary" (click)="openCreateModal()">
      <i class="icon">+</i> Create Discount
    </button>
  </div>

  <!-- Filters -->
  <div class="filters-bar">
    <div class="search-box">
      <input
        type="text"
        placeholder="Search by name or code..."
        [(ngModel)]="searchTerm"
        (ngModelChange)="applyFilters()"
      />
    </div>

    <select [(ngModel)]="filterType" (ngModelChange)="applyFilters()">
      <option value="">All Types</option>
      <option *ngFor="let type of discountTypes" [value]="type.value">
        {{ type.label }}
      </option>
    </select>

    <select [(ngModel)]="filterStatus" (ngModelChange)="applyFilters()">
      <option value="">All Status</option>
      <option value="active">Active</option>
      <option value="inactive">Inactive</option>
    </select>

    <span class="count">{{ filteredDiscounts.length }} discounts</span>
  </div>

  <!-- Discounts Table -->
  <div class="table-container">
    <table class="discount-table">
      <thead>
        <tr>
          <th>Name / Code</th>
          <th>Type</th>
          <th>Value</th>
          <th>Applies To</th>
          <th>Valid Period</th>
          <th>Usage</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let discount of paginatedDiscounts">
          <td>
            <div class="discount-name">{{ discount.name }}</div>
            <div class="discount-code" *ngIf="discount.code">
              <span class="code-badge">{{ discount.code }}</span>
            </div>
          </td>
          <td>
            <span class="badge" [ngClass]="getDiscountTypeBadge(discount.discount_type)">
              {{ discount.discount_type | titlecase }}
            </span>
          </td>
          <td>
            <span *ngIf="discount.discount_type === 'percentage'">{{ discount.discount_value }}%</span>
            <span *ngIf="discount.discount_type === 'fixed_amount'">${{ discount.discount_value }}</span>
            <span *ngIf="discount.discount_type === 'buy_x_get_y'">
              Buy {{ discount.buy_quantity }} Get {{ discount.get_quantity }}
            </span>
            <span *ngIf="discount.discount_type === 'bulk_discount'">Tiered</span>
          </td>
          <td>{{ discount.applies_to | titlecase }}</td>
          <td>
            <div class="date-range">
              <div>{{ formatDate(discount.valid_from!) }}</div>
              <div class="to">to</div>
              <div>{{ formatDate(discount.valid_until!) }}</div>
            </div>
            <div *ngIf="isExpired(discount)" class="status-label expired">Expired</div>
            <div *ngIf="isNotStarted(discount)" class="status-label not-started">Not Started</div>
          </td>
          <td>
            <div class="usage-info">
              <span>{{ discount.current_uses }}</span>
              <span *ngIf="discount.maximum_uses"> / {{ discount.maximum_uses }}</span>
              <span *ngIf="!discount.maximum_uses"> / Unlimited</span>
            </div>
            <div class="usage-bar" *ngIf="discount.maximum_uses">
              <div class="usage-fill" [style.width.%]="getUsagePercentage(discount)"></div>
            </div>
          </td>
          <td>
            <div class="status-toggle">
              <label class="switch">
                <input
                  type="checkbox"
                  [checked]="discount.is_active"
                  (change)="toggleStatus(discount)"
                />
                <span class="slider"></span>
              </label>
              <span class="status-text">
                {{ discount.is_active ? 'Active' : 'Inactive' }}
              </span>
            </div>
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn-icon btn-edit" (click)="openEditModal(discount)" title="Edit">
                âœŽ
              </button>
              <button class="btn-icon btn-delete" (click)="deleteDiscount(discount.id)" title="Delete">
                ðŸ—‘
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="pagination" *ngIf="totalPages > 1">
    <button
      class="page-btn"
      (click)="changePage(currentPage - 1)"
      [disabled]="currentPage === 1"
    >
      Previous
    </button>

    <span class="page-info">
      Page {{ currentPage }} of {{ totalPages }}
    </span>

    <button
      class="page-btn"
      (click)="changePage(currentPage + 1)"
      [disabled]="currentPage === totalPages"
    >
      Next
    </button>
  </div>

  <!-- Discount Modal -->
  <div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ editMode ? 'Edit Discount' : 'Create New Discount' }}</h3>
        <button class="close-btn" (click)="closeModal()">Ã—</button>
      </div>

      <div class="modal-body">
        <form>
          <!-- Basic Information -->
          <div class="form-section">
            <h4>Basic Information</h4>
            
            <div class="form-group">
              <label>Discount Name *</label>
              <input
                type="text"
                [(ngModel)]="currentDiscount.name"
                name="name"
                placeholder="e.g., Summer Sale 2024"
                required
              />
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Discount Type *</label>
                <select [(ngModel)]="currentDiscount.discount_type" name="discount_type">
                  <option *ngFor="let type of discountTypes" [value]="type.value">
                    {{ type.label }}
                  </option>
                </select>
              </div>

              <div class="form-group" *ngIf="currentDiscount.discount_type === 'percentage' || currentDiscount.discount_type === 'fixed_amount'">
                <label>
                  {{ currentDiscount.discount_type === 'percentage' ? 'Percentage (%)' : 'Amount ($)' }} *
                </label>
                <input
                  type="number"
                  [(ngModel)]="currentDiscount.discount_value"
                  name="discount_value"
                  [max]="currentDiscount.discount_type === 'percentage' ? 100 : 9999999"
                  min="0"
                  step="0.01"
                />
              </div>
            </div>

            <div class="form-group">
              <label>Coupon Code (optional)</label>
              <input
                type="text"
                [(ngModel)]="currentDiscount.code"
                name="code"
                placeholder="e.g., SAVE20"
                style="text-transform: uppercase"
              />
            </div>

            <div class="form-group">
              <label>Description</label>
              <textarea
                [(ngModel)]="currentDiscount.description"
                name="description"
                rows="3"
                placeholder="Describe this discount..."
              ></textarea>
            </div>
          </div>

          <!-- Buy X Get Y Settings -->
          <div class="form-section" *ngIf="currentDiscount.discount_type === 'buy_x_get_y'">
            <h4>Buy X Get Y Settings</h4>
            
            <div class="form-row">
              <div class="form-group">
                <label>Buy Quantity *</label>
                <input
                  type="number"
                  [(ngModel)]="currentDiscount.buy_quantity"
                  name="buy_quantity"
                  min="1"
                />
              </div>

              <div class="form-group">
                <label>Get Quantity *</label>
                <input
                  type="number"
                  [(ngModel)]="currentDiscount.get_quantity"
                  name="get_quantity"
                  min="1"
                />
              </div>

              <div class="form-group">
                <label>Discount on Free Items (%)</label>
                <input
                  type="number"
                  [(ngModel)]="currentDiscount.get_discount_percentage"
                  name="get_discount_percentage"
                  min="0"
                  max="100"
                  value="100"
                />
              </div>
            </div>
          </div>

          <!-- Bulk Discount Tiers -->
          <div class="form-section" *ngIf="currentDiscount.discount_type === 'bulk_discount'">
            <h4>Bulk Discount Tiers</h4>
            
            <div class="tier-list">
              <div class="tier-item" *ngFor="let tier of bulkTiers; let i = index">
                <span>Buy {{ tier.quantity }}+ items â†’ {{ tier.discount }}% off</span>
                <button type="button" class="btn-remove" (click)="removeBulkTier(i)">Ã—</button>
              </div>
            </div>

            <div class="tier-add">
              <input
                type="number"
                [(ngModel)]="newTierQty"
                name="newTierQty"
                placeholder="Quantity"
                min="1"
              />
              <input
                type="number"
                [(ngModel)]="newTierDiscount"
                name="newTierDiscount"
                placeholder="Discount %"
                min="0"
                max="100"
              />
              <button type="button" class="btn btn-secondary" (click)="addBulkTier()">
                Add Tier
              </button>
            </div>
          </div>

          <!-- Application Rules -->
          <div class="form-section">
            <h4>Application Rules</h4>
            
            <div class="form-row">
              <div class="form-group">
                <label>Applies To</label>
                <select [(ngModel)]="currentDiscount.applies_to" name="applies_to">
                  <option *ngFor="let option of appliesTo" [value]="option.value">
                    {{ option.label }}
                  </option>
                </select>
              </div>

              <div class="form-group">
                <label>Application Method</label>
                <select [(ngModel)]="currentDiscount.application_method" name="application_method">
                  <option *ngFor="let method of applicationMethods" [value]="method.value">
                    {{ method.label }}
                  </option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Minimum Purchase ($)</label>
                <input
                  type="number"
                  [(ngModel)]="currentDiscount.minimum_purchase"
                  name="minimum_purchase"
                  min="0"
                  step="0.01"
                />
              </div>

              <div class="form-group">
                <label>Minimum Quantity</label>
                <input
                  type="number"
                  [(ngModel)]="currentDiscount.minimum_quantity"
                  name="minimum_quantity"
                  min="0"
                />
              </div>

              <div class="form-group">
                <label>Priority</label>
                <input
                  type="number"
                  [(ngModel)]="currentDiscount.priority"
                  name="priority"
                  min="0"
                />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Maximum Uses (leave empty for unlimited)</label>
                <input
                  type="number"
                  [(ngModel)]="currentDiscount.maximum_uses"
                  name="maximum_uses"
                  min="1"
                />
              </div>

              <div class="form-group">
                <label>Max Uses Per Customer</label>
                <input
                  type="number"
                  [(ngModel)]="currentDiscount.max_uses_per_customer"
                  name="max_uses_per_customer"
                  min="1"
                />
              </div>
            </div>

            <div class="form-group checkbox-group">
              <label>
                <input
                  type="checkbox"
                  [(ngModel)]="currentDiscount.can_combine"
                  name="can_combine"
                />
                Can be combined with other discounts
              </label>
            </div>
          </div>

          <!-- Validity Period -->
          <div class="form-section">
            <h4>Validity Period</h4>
            
            <div class="form-row">
              <div class="form-group">
                <label>Valid From</label>
                <input
                  type="datetime-local"
                  [(ngModel)]="currentDiscount.valid_from"
                  name="valid_from"
                />
              </div>

              <div class="form-group">
                <label>Valid Until</label>
                <input
                  type="datetime-local"
                  [(ngModel)]="currentDiscount.valid_until"
                  name="valid_until"
                />
              </div>
            </div>
          </div>

          <!-- Status -->
          <div class="form-section">
            <div class="form-group checkbox-group">
              <label>
                <input
                  type="checkbox"
                  [(ngModel)]="currentDiscount.is_active"
                  name="is_active"
                />
                Active
              </label>
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeModal()">Cancel</button>
        <button class="btn btn-primary" (click)="saveDiscount()">
          {{ editMode ? 'Update' : 'Create' }} Discount
        </button>
      </div>
    </div>
  </div>
</div>
