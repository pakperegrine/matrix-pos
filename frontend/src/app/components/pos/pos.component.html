<div class="pos-root">
  <div class="pos-layout">
    <div class="products-section">
      <div class="section-header">
        <h3 class="section-title">Products</h3>
        <div class="header-actions">
          <button class="btn-cash-management" routerLink="/cash-management" title="Cash Management">
            <i class="fas fa-cash-register"></i> Cash Management
          </button>
          <div class="product-count">{{ filteredProducts.length }} of {{ products.length }} items</div>
        </div>
      </div>

      <!-- Search and Filter Bar -->
      <div class="filter-bar">
        <div class="search-box">
          <input 
            type="text" 
            class="search-input"
            [placeholder]="settingsService.isBarcodeScannerEnabled() ? 'Search by name, barcode, or SKU... (Scan or type)' : 'Search by name or SKU...'"
            [(ngModel)]="searchQuery"
            (input)="onSearchChange()"
            (keypress)="onSearchKeyPress($event)"
          />
          <span class="search-icon">{{ settingsService.isBarcodeScannerEnabled() ? 'üì∑' : 'üîç' }}</span>
        </div>

        <div class="category-filter">
          <select 
            class="category-select"
            [(ngModel)]="selectedCategory"
            (change)="onCategoryChange()"
          >
            <option value="">All Categories</option>
            <option *ngFor="let cat of (categories || [])" [value]="cat">{{ cat }}</option>
          </select>
        </div>

        <button 
          *ngIf="searchQuery || selectedCategory" 
          class="clear-filters-btn"
          (click)="clearFilters()"
        >
          Clear Filters
        </button>
      </div>

      <!-- Product Table -->
      <div class="product-table-container">
        <table class="product-table">
          <thead>
            <tr>
              <th>Product Name</th>
              <th>SKU</th>
              <th>Barcode</th>
              <th>Category</th>
              <th>Price</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let p of (filteredProducts || [])" class="product-row" (click)="addToCart(p)">
              <td class="product-name">{{ p.name }}</td>
              <td class="product-sku">{{ p.sku || '-' }}</td>
              <td class="product-barcode">{{ p.barcode || '-' }}</td>
              <td class="product-category">{{ p.category_id || '-' }}</td>
              <td class="product-price">{{ p.price | customCurrency }}</td>
              <td class="product-action">
                <button class="add-btn" (click)="addToCart(p); $event.stopPropagation()">+ Add</button>
              </td>
            </tr>
            <tr *ngIf="filteredProducts.length === 0">
              <td colspan="6" class="no-results">No products found</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="cart-section">
      <app-cart-panel 
        [cart]="cart" 
        [total]="total"
        [subtotal]="subtotal"
        [discountAmount]="discountAmount"
        [taxAmount]="taxAmount"
        (updateQuantity)="updateQuantity($event)"
        (removeItem)="removeItem($event)"
        (checkout)="openCheckout()"
        (clearCart)="clearCart()"
      ></app-cart-panel>
    </div>
  </div>

  <!-- Checkout Modal -->
  <app-modal
    [isOpen]="showCheckoutModal"
    [title]="'Checkout'"
    [size]="'md'"
    [closable]="!processingCheckout"
    [showFooter]="false"
    (close)="closeCheckout()"
  >
    <div class="checkout-content">
      <div class="checkout-summary">
        <h4>Order Summary</h4>
          <!-- <div class="summary-items" *ngIf="(cart || []).length > 0">
            <div *ngFor="let item of (cart || [])" class="summary-item">
              <div class="summary-item-name">
                {{ item.product.name }}
                <span class="summary-item-qty">√ó{{ item.qty }}</span>
              </div>
              <div class="summary-item-amount">{{ (item.product.price * item.qty) | customCurrency }}</div>
            </div>
          </div> -->
        <div class="summary-subtotal" *ngIf="discountAmount > 0">
          <span>Subtotal (before discount)</span>
          <span>{{ subtotal | customCurrency }}</span>
        </div>
        <div class="summary-discount" *ngIf="discountAmount > 0">
          <span class="discount-label">Discount:</span>
          <span class="discount-value">-{{ discountAmount | customCurrency }}</span>
        </div>
        <div class="summary-tax" *ngIf="settingsService.isTaxEnabled()">
          <span>{{ settingsService.getTaxLabel() }} ({{ settingsService.getTaxRate() }}%):</span>
          <span>{{ taxAmount | customCurrency }}</span>
        </div>
        <div class="summary-total">
          <span>Total:</span>
          <span class="total-value">{{ total | customCurrency }}</span>
        </div>
        <div *ngIf="discountAmount > 0" class="savings-message">
          üéâ You're saving {{ discountAmount | customCurrency }}!
        </div>
      </div>

      <!-- Discount Section -->
      <div class="discount-section" *ngIf="settingsService.isDiscountsEnabled()">
        <h4>üí∞ Discounts & Coupons</h4>
        
        <!-- Coupon Code Input -->
        <div class="coupon-input-group">
          <input
            type="text"
            [(ngModel)]="couponCode"
            placeholder="Enter coupon code"
            class="coupon-input"
            (keyup.enter)="applyCouponCode()"
          />
          <button
            *ngIf="!couponCode"
            class="apply-coupon-btn"
            (click)="applyCouponCode()"
            [disabled]="validatingCoupon"
          >
            {{ validatingCoupon ? '...' : 'Apply' }}
          </button>
          <button
            *ngIf="couponCode"
            class="remove-coupon-btn"
            (click)="removeCoupon()"
            title="Remove coupon"
          >
            √ó
          </button>
        </div>

        <!-- Applied Discounts -->
        <div *ngIf="appliedDiscountsList.length > 0" class="applied-discounts">
          <div *ngFor="let discount of appliedDiscountsList" class="discount-item">
            <span class="discount-name">‚úì {{ discount.discount_name }}</span>
            <span class="discount-value">-{{ discount.discount_amount | customCurrency }}</span>
          </div>
        </div>
      </div>

      <!-- Customer Selection -->
      <div class="customer-section" *ngIf="settingsService.isCustomerSelectionEnabled()">
        <h4>Customer <span *ngIf="settingsService.isCustomerRequired()" class="required">*</span></h4>
        <ng-select
          [(ngModel)]="selectedCustomerId"
          [items]="customers"
          bindLabel="name"
          bindValue="id"
          [searchable]="true"
          [clearable]="true"
          [loading]="customersLoading"
          placeholder="Select or search customer..."
          (search)="onCustomerSearch($event.term)"
          class="customer-ng-select"
        >
          <ng-template ng-option-tmp let-item="item">
            <div class="customer-option">
              <div class="customer-name">{{ item.name }}</div>
              <div class="customer-details">
                <span *ngIf="item.phone">üìû {{ item.phone }}</span>
                <span *ngIf="item.email && !item.phone">üìß {{ item.email }}</span>
                <span *ngIf="item.customer_type" class="customer-type-badge">{{ item.customer_type }}</span>
              </div>
            </div>
          </ng-template>
          <ng-template ng-label-tmp let-item="item">
            <div class="selected-customer">
              {{ item.name }} <span class="customer-contact">- {{ item.phone || item.email }}</span>
            </div>
          </ng-template>
        </ng-select>
        <div *ngIf="settingsService.isCustomerRequired() && !selectedCustomerId" class="required-note">
          ‚ö†Ô∏è Customer selection is required
        </div>
      </div>

      <div class="payment-section">
        <h4>Payment Method</h4>
        <div class="payment-methods">
          <label class="payment-option">
            <input type="radio" name="payment" value="cash" [(ngModel)]="paymentMethod" (change)="onPaymentMethodChange('cash')" />
            <span class="option-label">üíµ Cash</span>
          </label>
          <label class="payment-option">
            <input type="radio" name="payment" value="card" [(ngModel)]="paymentMethod" (change)="onPaymentMethodChange('card')" />
            <span class="option-label">üí≥ Card</span>
          </label>
        </div>

        <div *ngIf="paymentMethod === 'cash'" class="cash-payment">
          <label class="input-label">Amount Paid:</label>
          <input 
            type="number" 
            class="amount-input" 
            #cashAmountInput
            [(ngModel)]="amountPaid"
            [min]="total"
            step="0.01"
          />
          <div class="change-display" *ngIf="amountPaid >= total">
            <span>Change:</span>
            <span class="change-value">{{ change | customCurrency }}</span>
          </div>
        </div>
      </div>

      <div class="checkout-actions">
        <button 
          class="btn btn-secondary" 
          (click)="closeCheckout()"
          [disabled]="processingCheckout"
        >
          Cancel
        </button>
        <button 
          class="btn btn-primary btn-complete" 
          (click)="processCheckout()"
          [disabled]="processingCheckout || (paymentMethod === 'cash' && amountPaid < total)"
        >
          <span *ngIf="!processingCheckout">Complete Sale</span>
          <span *ngIf="processingCheckout">Processing...</span>
        </button>
      </div>
    </div>
  </app-modal>
</div>
